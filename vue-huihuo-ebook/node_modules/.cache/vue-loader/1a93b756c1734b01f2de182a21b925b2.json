{"remainingRequest":"E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\src\\components\\Ebook\\EbookBookmark.vue?vue&type=script&lang=js&","dependencies":[{"path":"E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\src\\components\\Ebook\\EbookBookmark.vue","mtime":1588676683306},{"path":"E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\JodPreparation\\Practice\\项目\\huihuo-ebook\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KDQppbXBvcnQgeyByZWFsUHggfSBmcm9tICIuLi8uLi91dGlscy91dGlscyI7DQppbXBvcnQgQm9va21hcmsgZnJvbSAiLi9Cb29rbWFyayI7DQppbXBvcnQgeyBlYm9va01peGluIH0gZnJvbSAiLi4vLi4vdXRpbHMvbWl4aW4iOw0KaW1wb3J0IHsgZ2V0Qm9va21hcmssIHNhdmVCb29rbWFyayB9IGZyb20gIi4uLy4uL3V0aWxzL2xvY2FsU3RvcmFnZSI7DQoNCmNvbnN0IEJMVUUgPSAiIzM0NmNiYyI7DQpjb25zdCBXSElURSA9ICIjZmZmIjsNCmV4cG9ydCBkZWZhdWx0IHsNCiAgbWl4aW5zOiBbZWJvb2tNaXhpbl0sDQogIGNvbXBvbmVudHM6IHsNCiAgICBCb29rbWFyaw0KICB9LA0KICBjb21wdXRlZDogew0KICAgIGhlaWdodCgpIHsNCiAgICAgIHJldHVybiByZWFsUHgoMzUpOw0KICAgIH0sDQogICAgdGhyZXNob2xkKCkgew0KICAgICAgcmV0dXJuIHJlYWxQeCg1NSk7DQogICAgfSwNCiAgICBmaXhlZFN0eWxlKCkgew0KICAgICAgcmV0dXJuIHsNCiAgICAgICAgcG9zaXRpb246ICJmaXhlZCIsDQogICAgICAgIHRvcDogMCwNCiAgICAgICAgcmlnaHQ6IGAkeyh3aW5kb3cuaW5uZXJXaWR0aCAtIHRoaXMuJHJlZnMuYm9va21hcmsuY2xpZW50V2lkdGgpIC8gMn1weGANCiAgICAgIH07DQogICAgfQ0KICB9LA0KICB3YXRjaDogew0KICAgIG9mZnNldFkodikgew0KICAgICAgaWYgKCF0aGlzLmJvb2tBdmFpbGFibGUgfHwgdGhpcy5tZW51VmlzaWJsZSB8fCB0aGlzLnNldHRpbmdWaXNpYmxlID49IDApIHsNCiAgICAgICAgcmV0dXJuOw0KICAgICAgfQ0KICAgICAgaWYgKHYgPj0gdGhpcy5oZWlnaHQgJiYgdiA8IHRoaXMudGhyZXNob2xkKSB7DQogICAgICAgIHRoaXMuYmVmb3JlVGhyZXNob2xkKHYpOw0KICAgICAgfSBlbHNlIGlmICh2ID49IHRoaXMudGhyZXNob2xkKSB7DQogICAgICAgIHRoaXMuYWZ0ZXJUaHJlc2hvbGQodik7DQogICAgICB9IGVsc2UgaWYgKHYgPiAwICYmIHYgPCB0aGlzLmhlaWdodCkgew0KICAgICAgICB0aGlzLmJlZm9yZUhlaWdodCgpOw0KICAgICAgfSBlbHNlIGlmICh2ID09PSAwKSB7DQogICAgICAgIHRoaXMucmVzdG9yZSgpOw0KICAgICAgfQ0KICAgIH0sDQogICAgaXNCb29rbWFyayhpc0Jvb2ttYXJrKSB7DQogICAgICB0aGlzLmlzRml4ZWQgPSBpc0Jvb2ttYXJrOw0KICAgICAgaWYgKGlzQm9va21hcmspIHsNCiAgICAgICAgdGhpcy5jb2xvciA9IEJMVUU7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLmNvbG9yID0gV0hJVEU7DQogICAgICB9DQogICAgfQ0KICB9LA0KICBkYXRhKCkgew0KICAgIHJldHVybiB7DQogICAgICB0ZXh0OiAiIiwNCiAgICAgIGNvbG9yOiBXSElURSwNCiAgICAgIGlzRml4ZWQ6IGZhbHNlDQogICAgfTsNCiAgfSwNCiAgbWV0aG9kczogew0KICAgIGFkZEJvb2ttYXJrKCkgew0KICAgICAgdGhpcy5ib29rbWFyayA9IGdldEJvb2ttYXJrKHRoaXMuZmlsZU5hbWUpOw0KICAgICAgaWYgKCF0aGlzLmJvb2ttYXJrKSB7DQogICAgICAgIHRoaXMuYm9va21hcmsgPSBbXTsNCiAgICAgIH0NCiAgICAgIGNvbnN0IGN1cnJlbnRMb2NhdGlvbiA9IHRoaXMuY3VycmVudEJvb2sucmVuZGl0aW9uLmN1cnJlbnRMb2NhdGlvbigpOw0KICAgICAgY29uc3QgY2ZpYmFzZSA9IGN1cnJlbnRMb2NhdGlvbi5zdGFydC5jZmkucmVwbGFjZSgvIS4qLywgIiIpOw0KICAgICAgY29uc3QgY2Zpc3RhcnQgPSBjdXJyZW50TG9jYXRpb24uc3RhcnQuY2ZpDQogICAgICAgIC5yZXBsYWNlKC8uKiEvLCAiIikNCiAgICAgICAgLnJlcGxhY2UoL1wpJC8sICIiKTsNCiAgICAgIGNvbnN0IGNmaWVuZCA9IGN1cnJlbnRMb2NhdGlvbi5lbmQuY2ZpDQogICAgICAgIC5yZXBsYWNlKC8uKiEvLCAiIikNCiAgICAgICAgLnJlcGxhY2UoL1wpJC8sICIiKTsNCiAgICAgIGNvbnN0IGNmaXJhbmdlID0gYCR7Y2ZpYmFzZX0hLCR7Y2Zpc3RhcnR9LCR7Y2ZpZW5kfSlgOw0KICAgICAgdGhpcy5jdXJyZW50Qm9vay5nZXRSYW5nZShjZmlyYW5nZSkudGhlbihyYW5nZSA9PiB7DQogICAgICAgIC8v5Y675o6J56m65qC8DQogICAgICAgIGNvbnN0IHRleHQgPSByYW5nZS50b1N0cmluZygpLnJlcGxhY2UoL1xzXHMvZywgIiIpOw0KICAgICAgICAvL+WtmOWCqOS5puetvuS/oeaBrw0KICAgICAgICBpZiAoIShjdXJyZW50TG9jYXRpb24uc3RhcnQuY2ZpIGluIHRoaXMuYm9va21hcmspKSB7DQogICAgICAgICAgLy/kuabnrb7ljrvph40NCiAgICAgICAgICB0aGlzLmJvb2ttYXJrLnB1c2goew0KICAgICAgICAgICAgY2ZpOiBjdXJyZW50TG9jYXRpb24uc3RhcnQuY2ZpLA0KICAgICAgICAgICAgdGV4dDogdGV4dA0KICAgICAgICAgIH0pOw0KICAgICAgICAgIHNhdmVCb29rbWFyayh0aGlzLmZpbGVOYW1lLCB0aGlzLmJvb2ttYXJrKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQogICAgfSwNCiAgICByZW1vdmVCb29rbWFyaygpIHsNCiAgICAgIGNvbnN0IGN1cnJlbnRMb2NhdGlvbiA9IHRoaXMuY3VycmVudEJvb2sucmVuZGl0aW9uLmN1cnJlbnRMb2NhdGlvbigpOw0KICAgICAgY29uc3QgY2ZpID0gY3VycmVudExvY2F0aW9uLnN0YXJ0LmNmaTsNCiAgICAgIHRoaXMuYm9va21hcmsgPSBnZXRCb29rbWFyayh0aGlzLmZpbGVOYW1lKTsNCiAgICAgIGlmICh0aGlzLmJvb2ttYXJrKSB7DQogICAgICAgIHNhdmVCb29rbWFyaygNCiAgICAgICAgICB0aGlzLmZpbGVOYW1lLA0KICAgICAgICAgIHRoaXMuYm9va21hcmsuZmlsdGVyKGl0ZW0gPT4gaXRlbS5jZmkgIT09IGNmaSkNCiAgICAgICAgKTsNCiAgICAgICAgdGhpcy5zZXRJc0Jvb2ttYXJrKGZhbHNlKTsNCiAgICAgIH0NCiAgICB9LA0KICAgIHJlc3RvcmUoKSB7DQogICAgICAvLyDnirbmgIE077ya5b2S5L2NDQogICAgICBzZXRUaW1lb3V0KCgpID0+IHsNCiAgICAgICAgdGhpcy4kcmVmcy5ib29rbWFyay5zdHlsZS50b3AgPSBgJHstdGhpcy5oZWlnaHR9cHhgOw0KICAgICAgICB0aGlzLiRyZWZzLmljb25Eb3duLnN0eWxlLnRyYW5zZm9ybSA9ICJyb3RhdGUoMGRlZykiOw0KICAgICAgfSwgMjAwKTsNCiAgICAgIGlmICh0aGlzLmlzRml4ZWQpIHsNCiAgICAgICAgdGhpcy5zZXRJc0Jvb2ttYXJrKHRydWUpOw0KICAgICAgICB0aGlzLmFkZEJvb2ttYXJrKCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLnNldElzQm9va21hcmsoZmFsc2UpOw0KICAgICAgICB0aGlzLnJlbW92ZUJvb2ttYXJrKCk7DQogICAgICB9DQogICAgfSwNCiAgICBiZWZvcmVIZWlnaHQoKSB7DQogICAgICAvLyDnirbmgIEx77ya5pyq6LaF6L+H5Lmm562+55qE6auY5bqmDQogICAgICBpZiAodGhpcy5pc0Jvb2ttYXJrKSB7DQogICAgICAgIHRoaXMudGV4dCA9IHRoaXMuJHQoImJvb2sucHVsbGRvd25EZWxldGVNYXJrIik7DQogICAgICAgIHRoaXMuY29sb3IgPSBCTFVFOw0KICAgICAgICB0aGlzLmlzRml4ZWQgPSB0cnVlOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGhpcy50ZXh0ID0gdGhpcy4kdCgiYm9vay5wdWxsZG93bkFkZE1hcmsiKTsNCiAgICAgICAgdGhpcy5jb2xvciA9IFdISVRFOw0KICAgICAgICB0aGlzLmlzRml4ZWQgPSBmYWxzZTsNCiAgICAgIH0NCiAgICB9LA0KICAgIGJlZm9yZVRocmVzaG9sZCh2KSB7DQogICAgICAvLyDnirbmgIEy77ya5pyq5Yiw6L6+6Zu255WM54q25oCBDQogICAgICB0aGlzLiRyZWZzLmJvb2ttYXJrLnN0eWxlLnRvcCA9IGAkey12fXB4YDsNCiAgICAgIHRoaXMuYmVmb3JlSGVpZ2h0KCk7DQogICAgICBjb25zdCBpY29uRG93biA9IHRoaXMuJHJlZnMuaWNvbkRvd247DQogICAgICBpZiAoaWNvbkRvd24uc3R5bGUudHJhbnNmb3JtID09PSAicm90YXRlKDE4MGRlZykiKSB7DQogICAgICAgIGljb25Eb3duLnN0eWxlLnRyYW5zZm9ybSA9ICJyb3RhdGUoMGRlZykiOw0KICAgICAgfQ0KICAgIH0sDQogICAgYWZ0ZXJUaHJlc2hvbGQodikgew0KICAgICAgLy8g54q25oCBM++8mui2hei2iumbtueVjOeKtuaAgQ0KICAgICAgdGhpcy4kcmVmcy5ib29rbWFyay5zdHlsZS50b3AgPSBgJHstdn1weGA7DQogICAgICBpZiAodGhpcy5pc0Jvb2ttYXJrKSB7DQogICAgICAgIHRoaXMudGV4dCA9IHRoaXMuJHQoImJvb2sucmVsZWFzZURlbGV0ZU1hcmsiKTsNCiAgICAgICAgdGhpcy5jb2xvciA9IFdISVRFOw0KICAgICAgICB0aGlzLmlzRml4ZWQgPSBmYWxzZTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMudGV4dCA9IHRoaXMuJHQoImJvb2sucmVsZWFzZUFkZE1hcmsiKTsNCiAgICAgICAgdGhpcy5jb2xvciA9IEJMVUU7DQogICAgICAgIHRoaXMuaXNGaXhlZCA9IHRydWU7DQogICAgICB9DQogICAgICBjb25zdCBpY29uRG93biA9IHRoaXMuJHJlZnMuaWNvbkRvd247DQogICAgICBpZiAoDQogICAgICAgIGljb25Eb3duLnN0eWxlLnRyYW5zZm9ybSA9PT0gIiIgfHwNCiAgICAgICAgaWNvbkRvd24uc3R5bGUudHJhbnNmb3JtID09PSAicm90YXRlKDBkZWcpIg0KICAgICAgKSB7DQogICAgICAgIGljb25Eb3duLnN0eWxlLnRyYW5zZm9ybSA9ICJyb3RhdGUoMTgwZGVnKSI7DQogICAgICB9DQogICAgfQ0KICB9DQp9Ow0K"},{"version":3,"sources":["EbookBookmark.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;AAeA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"EbookBookmark.vue","sourceRoot":"src/components/Ebook","sourcesContent":["<template>\r\n  <div class=\"ebook-bookmark\" ref=\"bookmark\">\r\n    <div class=\"ebook-bookmark-text-wrapper\">\r\n      <div class=\"ebook-bookmark-down-wrapper\" ref=\"iconDown\">\r\n        <span class=\"icon-down\"></span>\r\n      </div>\r\n      <div class=\"ebook-bookmark-text\">{{ text }}</div>\r\n    </div>\r\n    <div class=\"ebook-bookmark-icon-wrapper\" :style=\"isFixed ? fixedStyle : {}\">\r\n      <bookmark :color=\"color\" :width=\"15\" :height=\"35\"></bookmark>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { realPx } from \"../../utils/utils\";\r\nimport Bookmark from \"./Bookmark\";\r\nimport { ebookMixin } from \"../../utils/mixin\";\r\nimport { getBookmark, saveBookmark } from \"../../utils/localStorage\";\r\n\r\nconst BLUE = \"#346cbc\";\r\nconst WHITE = \"#fff\";\r\nexport default {\r\n  mixins: [ebookMixin],\r\n  components: {\r\n    Bookmark\r\n  },\r\n  computed: {\r\n    height() {\r\n      return realPx(35);\r\n    },\r\n    threshold() {\r\n      return realPx(55);\r\n    },\r\n    fixedStyle() {\r\n      return {\r\n        position: \"fixed\",\r\n        top: 0,\r\n        right: `${(window.innerWidth - this.$refs.bookmark.clientWidth) / 2}px`\r\n      };\r\n    }\r\n  },\r\n  watch: {\r\n    offsetY(v) {\r\n      if (!this.bookAvailable || this.menuVisible || this.settingVisible >= 0) {\r\n        return;\r\n      }\r\n      if (v >= this.height && v < this.threshold) {\r\n        this.beforeThreshold(v);\r\n      } else if (v >= this.threshold) {\r\n        this.afterThreshold(v);\r\n      } else if (v > 0 && v < this.height) {\r\n        this.beforeHeight();\r\n      } else if (v === 0) {\r\n        this.restore();\r\n      }\r\n    },\r\n    isBookmark(isBookmark) {\r\n      this.isFixed = isBookmark;\r\n      if (isBookmark) {\r\n        this.color = BLUE;\r\n      } else {\r\n        this.color = WHITE;\r\n      }\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      text: \"\",\r\n      color: WHITE,\r\n      isFixed: false\r\n    };\r\n  },\r\n  methods: {\r\n    addBookmark() {\r\n      this.bookmark = getBookmark(this.fileName);\r\n      if (!this.bookmark) {\r\n        this.bookmark = [];\r\n      }\r\n      const currentLocation = this.currentBook.rendition.currentLocation();\r\n      const cfibase = currentLocation.start.cfi.replace(/!.*/, \"\");\r\n      const cfistart = currentLocation.start.cfi\r\n        .replace(/.*!/, \"\")\r\n        .replace(/\\)$/, \"\");\r\n      const cfiend = currentLocation.end.cfi\r\n        .replace(/.*!/, \"\")\r\n        .replace(/\\)$/, \"\");\r\n      const cfirange = `${cfibase}!,${cfistart},${cfiend})`;\r\n      this.currentBook.getRange(cfirange).then(range => {\r\n        //去掉空格\r\n        const text = range.toString().replace(/\\s\\s/g, \"\");\r\n        //存储书签信息\r\n        if (!(currentLocation.start.cfi in this.bookmark)) {\r\n          //书签去重\r\n          this.bookmark.push({\r\n            cfi: currentLocation.start.cfi,\r\n            text: text\r\n          });\r\n          saveBookmark(this.fileName, this.bookmark);\r\n        }\r\n      });\r\n    },\r\n    removeBookmark() {\r\n      const currentLocation = this.currentBook.rendition.currentLocation();\r\n      const cfi = currentLocation.start.cfi;\r\n      this.bookmark = getBookmark(this.fileName);\r\n      if (this.bookmark) {\r\n        saveBookmark(\r\n          this.fileName,\r\n          this.bookmark.filter(item => item.cfi !== cfi)\r\n        );\r\n        this.setIsBookmark(false);\r\n      }\r\n    },\r\n    restore() {\r\n      // 状态4：归位\r\n      setTimeout(() => {\r\n        this.$refs.bookmark.style.top = `${-this.height}px`;\r\n        this.$refs.iconDown.style.transform = \"rotate(0deg)\";\r\n      }, 200);\r\n      if (this.isFixed) {\r\n        this.setIsBookmark(true);\r\n        this.addBookmark();\r\n      } else {\r\n        this.setIsBookmark(false);\r\n        this.removeBookmark();\r\n      }\r\n    },\r\n    beforeHeight() {\r\n      // 状态1：未超过书签的高度\r\n      if (this.isBookmark) {\r\n        this.text = this.$t(\"book.pulldownDeleteMark\");\r\n        this.color = BLUE;\r\n        this.isFixed = true;\r\n      } else {\r\n        this.text = this.$t(\"book.pulldownAddMark\");\r\n        this.color = WHITE;\r\n        this.isFixed = false;\r\n      }\r\n    },\r\n    beforeThreshold(v) {\r\n      // 状态2：未到达零界状态\r\n      this.$refs.bookmark.style.top = `${-v}px`;\r\n      this.beforeHeight();\r\n      const iconDown = this.$refs.iconDown;\r\n      if (iconDown.style.transform === \"rotate(180deg)\") {\r\n        iconDown.style.transform = \"rotate(0deg)\";\r\n      }\r\n    },\r\n    afterThreshold(v) {\r\n      // 状态3：超越零界状态\r\n      this.$refs.bookmark.style.top = `${-v}px`;\r\n      if (this.isBookmark) {\r\n        this.text = this.$t(\"book.releaseDeleteMark\");\r\n        this.color = WHITE;\r\n        this.isFixed = false;\r\n      } else {\r\n        this.text = this.$t(\"book.releaseAddMark\");\r\n        this.color = BLUE;\r\n        this.isFixed = true;\r\n      }\r\n      const iconDown = this.$refs.iconDown;\r\n      if (\r\n        iconDown.style.transform === \"\" ||\r\n        iconDown.style.transform === \"rotate(0deg)\"\r\n      ) {\r\n        iconDown.style.transform = \"rotate(180deg)\";\r\n      }\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style lang=\"scss\" rel=\"stylesheet/scss\" scoped>\r\n@import \"../../assets/styles/global\";\r\n\r\n.ebook-bookmark {\r\n  position: absolute;\r\n  top: px2rem(-35);\r\n  left: 0;\r\n  z-index: 200;\r\n  width: 100%;\r\n  height: px2rem(35);\r\n  .ebook-bookmark-text-wrapper {\r\n    position: absolute;\r\n    right: px2rem(45);\r\n    bottom: 0;\r\n    display: flex;\r\n    .ebook-bookmark-down-wrapper {\r\n      font-size: px2rem(14);\r\n      color: white;\r\n      transition: all 0.2s linear;\r\n      @include center;\r\n    }\r\n    .ebook-bookmark-text {\r\n      font-size: px2rem(14);\r\n      color: white;\r\n    }\r\n  }\r\n  .ebook-bookmark-icon-wrapper {\r\n    position: absolute;\r\n    right: 0;\r\n    bottom: 0;\r\n    margin-right: px2rem(15);\r\n  }\r\n}\r\n</style>\r\n"]}]}